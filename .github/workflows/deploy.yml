name: üöÄ CI/CD - Deploy to EC2

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  APP_NAME: secure-document-management
  DEPLOY_PATH: /home/ubuntu/secure-document-management
  DATABASE_URL: postgresql://postgres:password@localhost:5432/secure_document_management_test

jobs:
  # =================== SECURITY SCANS ===================
  
  # 1. Dependency Scanning with Snyk
  dependency-scan:
    name: ÔøΩ Dependency Scan (Snyk)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json

      - name: Upload Snyk report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: snyk-report
          path: snyk-report.json

  # 2. Secrets Scanning with GitGuardian
  secrets-scan:
    name: üîê Secrets Scan (GitGuardian)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@v1.25.0
        continue-on-error: true
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  # 3. Container Scanning with Trivy
  container-scan:
    name: üê≥ Container Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          docker build -t ${{ env.APP_NAME }}:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.APP_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Upload Trivy report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: trivy-report
          path: trivy-results.sarif

  # 4. SAST - Static Application Security Testing with SonarQube
  sast-scan:
    name: üîç SAST Scan (SonarQube)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage (if available)
        run: npm run test:cov || echo "No test coverage available"
        continue-on-error: true

      # Option 1: SonarCloud (requires SONAR_TOKEN)
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        if: ${{ secrets.SONAR_TOKEN != '' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.sources=src
            -Dsonar.tests=test
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/coverage/**

      # Option 2: SonarScanner CLI (local scan without server)
      - name: SonarScanner CLI (Standalone)
        if: ${{ secrets.SONAR_TOKEN == '' }}
        run: |
          echo "üìä Running SonarScanner in standalone mode (no server connection)..."
          
          # Download and setup SonarScanner
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          export PATH=$PATH:$PWD/sonar-scanner-5.0.1.3006-linux/bin
          
          # Create sonar-project.properties if not exists
          cat > sonar-project.properties << EOF
          sonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}
          sonar.projectName=${{ github.event.repository.name }}
          sonar.projectVersion=1.0
          sonar.sources=src
          sonar.tests=test
          sonar.sourceEncoding=UTF-8
          sonar.javascript.lcov.reportPaths=coverage/lcov.info
          sonar.exclusions=**/node_modules/**,**/dist/**,**/coverage/**,**/*.spec.ts,**/*.test.ts
          sonar.coverage.exclusions=**/*.spec.ts,**/*.test.ts,**/*.mock.ts
          EOF
          
          echo "‚úÖ SonarScanner configured for local analysis"
          echo "üí° To upload results to SonarCloud/SonarQube, add SONAR_TOKEN secret"
        continue-on-error: true

      # Option 3: Custom SonarQube Server
      - name: SonarQube Server Scan
        if: ${{ secrets.SONAR_HOST_URL != '' && secrets.SONAR_TOKEN != '' }}
        uses: sonarsource/sonarqube-scan-action@master
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}
            -Dsonar.sources=src
            -Dsonar.tests=test
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - name: SonarQube Quality Gate check
        if: ${{ secrets.SONAR_TOKEN != '' }}
        uses: sonarsource/sonarqube-quality-gate-action@master
        continue-on-error: true
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Upload SonarQube results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: sonarqube-results
          path: |
            .scannerwork/
            sonar-project.properties
        continue-on-error: true

  # 5. DAST - Dynamic Application Security Testing with OWASP ZAP
  dast-scan:
    name: üéØ DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: 'https://${{ secrets.EC2_HOST }}/api'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: Upload ZAP report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: zap-report
          path: report_html.html

  # 6. Code Quality & Linting
  code-quality:
    name: üìä Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.ts"
        continue-on-error: true

  # =================== BUILD & TEST (DISABLED) ===================
  # Build disabled - Security scans only
  # build-and-test:
  #   name: üèóÔ∏è Build & Test
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Skip build
  #       run: echo "‚è≠Ô∏è Build disabled - Running security scans only"

  # =================== SECURITY SUMMARY ===================
  security-summary:
    name: üìã Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, secrets-scan, container-scan, sast-scan, code-quality]
    if: always()
    steps:
      - name: Download all reports
        uses: actions/download-artifact@v3
        continue-on-error: true

      - name: Generate security summary
        run: |
          echo "# üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Dependency Scan (Snyk): ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Secrets Scan (GitGuardian): ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Container Scan (Trivy): ${{ needs.container-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ SAST Scan (CodeQL): ${{ needs.sast-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Reports Available:" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Artifacts' section for detailed security reports" >> $GITHUB_STEP_SUMMARY

  # =================== DEPLOY TO EC2 (DISABLED) ===================
  deploy:
    name: üöÄ Deploy to EC2 (Disabled)
    runs-on: ubuntu-latest
    needs: [security-summary]
    if: github.ref == 'refs/heads/main' && false

    steps:
      - name: Deployment disabled
        run: echo "‚è≠Ô∏è Deployment disabled - Security scans only mode"

      # - name: Checkout code
      #   uses: actions/checkout@v4

      # - name: Setup SSH
      #   uses: webfactory/ssh-agent@v0.8.0
      #   with:
      #     ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      # - name: Deploy to EC2
      #   run: |
      #     ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
      #       set -e
      #       
      #       echo "üöÄ Starting deployment..."
      #       
      #       # Navigate to project directory
      #       cd ${{ env.DEPLOY_PATH }}
      #       
      #       # Pull latest code
      #       echo "üì• Pulling latest code..."
      #       # git fetch origin
      #       # git reset --hard origin/main
      #       
      #       # Run deploy script
      #       echo "üèóÔ∏è Running deployment script..."
      #       # bash scripts/deploy-app.sh
      #       
      #       echo "üéâ Deployment completed successfully!"
      #     EOF

      # - name: Verify deployment
      #   run: |
      #     echo "üîç Verifying deployment..."
      #     sleep 15

      #     max_attempts=10
      #     attempt=1
      #     while [ $attempt -le $max_attempts ]; do
      #       if curl -f https://${{ secrets.EC2_HOST }}/api/health > /dev/null 2>&1; then
      #         echo "‚úÖ Application is accessible and healthy!"
      #         exit 0
      #       fi
      #       echo "Attempt $attempt/$max_attempts: Checking application health..."
      #       sleep 5
      #       attempt=$((attempt + 1))
      #     done

      #     echo "‚ö†Ô∏è Application verification timeout, but deployment may still be in progress..."
      #     exit 0

  # =================== NOTIFY ===================
  notify:
    name: üì¢ Security Scan Notification
    runs-on: ubuntu-latest
    needs: [security-summary]
    if: always()

    steps:
      - name: Notify success
        if: needs.security-summary.result == 'success'
        run: |
          echo "‚úÖ Security scans completed successfully!"
          echo "ÔøΩ All security checks passed"
          echo "üìä Check artifacts for detailed reports"

      - name: Notify failure
        if: needs.security-summary.result == 'failure'
        run: |
          echo "‚ö†Ô∏è Some security scans found issues!"
          echo "Please review the security reports in artifacts"
          echo "üìã Check GitHub Security tab for detailed findings"
