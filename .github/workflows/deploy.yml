name: DevSecOps Security Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  APP_NAME: secure-document-management

jobs:
  code-quality:
    name: ğŸ“Š Step 1 - Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - run: npm ci
      - run: npm run lint
        continue-on-error: true

  secrets-scan:
    name: ğŸ” Step 2 - Secrets Scan (GitGuardian)
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: GitGuardian/ggshield-action@v1.25.0
        continue-on-error: true
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  dependency-scan:
    name: ğŸ”’ Step 3 - Dependency Scan (Snyk)
    runs-on: ubuntu-latest
    needs: [secrets-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - run: npm ci
      - uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  sast-scan:
    name: ğŸ” Step 4 - SAST Scan (SonarQube)
    runs-on: ubuntu-latest
    needs: [dependency-scan]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - run: npm ci
      - run: npx prisma generate
        continue-on-error: true
      - run: npm run test:cov || true
        continue-on-error: true
      - uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  container-scan:
    name: ğŸ³ Step 5 - Container Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [sast-scan]
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t app:scan .
      - uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: app:scan
          severity: CRITICAL,HIGH

  dast-scan:
    name: ğŸ¯ Step 6 - DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: [container-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: https://api.example.com
          rules_file_name: .zap/rules.tsv
          cmd_options: -a

  security-summary:
    name: ğŸ“‹ Step 7 - Security Summary
    runs-on: ubuntu-latest
    needs: [code-quality, secrets-scan, dependency-scan, sast-scan, container-scan]
    if: always()
    steps:
      - run: |
          echo "# ğŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Step 1 | Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Step 2 | GitGuardian | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Step 3 | Snyk | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Step 4 | SonarQube | ${{ needs.sast-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Step 5 | Trivy | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ğŸš€ Step 8 - Deploy to EC2
    runs-on: ubuntu-latest
    needs: [security-summary]
    if: github.ref == 'refs/heads/main' && false
    steps:
      - run: echo "â­ï¸ Deployment disabled - Security scans only"

  notify:
    name: ğŸ“¢ Step 9 - Notification
    runs-on: ubuntu-latest
    needs: [security-summary]
    if: always()
    steps:
      - name: Success notification
        if: needs.security-summary.result == 'success'
        run: |
          echo "âœ… All security scans completed successfully!"
          echo "ğŸ”’ DevSecOps pipeline passed"
      - name: Failure notification
        if: needs.security-summary.result == 'failure'
        run: |
          echo "âš ï¸ Some security scans found issues!"
          echo "ğŸ“‹ Please review the security reports"
