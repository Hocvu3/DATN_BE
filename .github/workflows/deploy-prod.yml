name: ðŸ“¦ Production Deployment

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger when have tag: v1.0.0, v2.1.3, etc.

env:
  NODE_VERSION: '18'
  APP_NAME: secure-document-management

jobs:
  pre-deploy-checks:
    name: ðŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“Œ Validate tag format
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "âœ… Expected format: v1.0.0"
            exit 1
          fi
          echo "âœ… Tag format valid: $TAG_NAME"
      
      - name: ðŸ“‹ Extract release notes
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# ðŸš€ Production Release: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Released at:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: ðŸ”’ Security Scanning
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      
      - run: npm ci
      
      - name: ðŸ”’ Dependency Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: [security-scan]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate
      
      - name: ðŸ“Š Run linting
        run: npm run lint
        continue-on-error: true
      
      - name: ðŸ—ï¸ Build application
        run: npm run build
      
      - name: âœ… Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist/ directory not found"
            exit 1
          fi
          echo "âœ… Build successful"
          ls -la dist/

  build-docker-image:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: ðŸ—ï¸ Build and push Docker image
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          echo "ðŸ³ Building Docker image: ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${TAG_NAME}"
          docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${TAG_NAME} .
          docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${TAG_NAME} ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
          
          echo "ðŸ“¤ Pushing to Docker Hub..."
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${TAG_NAME}
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
          
          echo "âœ… Docker image pushed successfully"

  deploy-production:
    name: ðŸš€ Deploy to EC2 Production
    runs-on: ubuntu-latest
    needs: [build-docker-image]
    environment:
      name: production
      url: https://api.docuflow.id.vn
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸ“¦ Deploy to EC2
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e
            
            cd /home/${{ secrets.EC2_USER }}/secure-document-management
            
            echo 'ðŸ”„ Pulling latest changes...'
            git fetch --all --tags
            git checkout ${TAG_NAME}
            
            echo 'ðŸ³ Pulling Docker image from registry...'
            docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${TAG_NAME}
            
            echo 'ðŸ“ Updating docker-compose to use new image...'
            export IMAGE_TAG=${TAG_NAME}
            
            echo 'ðŸš€ Restarting containers...'
            docker-compose -f docker-compose.prod.yml --env-file .env.prod down app
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d app
            
            echo 'ðŸ§¹ Cleaning up old images...'
            docker image prune -f
            
            echo 'âœ… Deployment completed for version ${TAG_NAME}'
          "
      
      - name: ðŸ¥ Health check
        run: |
          echo "â³ Waiting for application to start..."
          sleep 15
          
          for i in {1..5}; do
            if curl -f -s https://api.docuflow.id.vn/health; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "â³ Attempt $i/5 failed, retrying..."
            sleep 10
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1

  notify:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    steps:
      - name: âœ… Success notification
        if: needs.deploy-production.result == 'success'
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# âœ… Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ðŸŸ¢ Live" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Application is now running in production!" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Failure notification
        if: needs.deploy-production.result == 'failure'
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# âŒ Production Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ðŸ”´ Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Please check the deployment logs and retry." >> $GITHUB_STEP_SUMMARY
          exit 1
