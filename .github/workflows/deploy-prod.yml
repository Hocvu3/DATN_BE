name: ðŸš€ Production Deployment

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger when have tag: v1.0.0, v2.1.3, etc.

env:
  APP_NAME: secure-document-management

jobs:
  validate-release:
    name: âœ… Validate Release
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.extract.outputs.tag_name }}
      commit_sha: ${{ steps.extract.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“Œ Validate tag format
        id: extract
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "âœ… Expected format: v1.0.0"
            exit 1
          fi
          
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "commit_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          
          echo "âœ… Tag format valid: $TAG_NAME"
          echo "ðŸ“¦ Commit SHA: $(echo ${{ github.sha }} | cut -c1-7)"
      
      - name: ðŸ“‹ Release summary
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# ðŸš€ Production Release: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Released at:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY

  pull-artifact:
    name: ðŸ“¥ Pull Docker Image
    runs-on: ubuntu-latest
    needs: [validate-release]
    steps:
      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: ðŸ“¥ Pull latest image from registry
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}"
          
          echo "ðŸ“¥ Pulling ${IMAGE_NAME}:latest"
          docker pull ${IMAGE_NAME}:latest
          
          echo "âœ… Image pulled successfully"
          docker images | grep ${{ env.APP_NAME }}
      
      - name: ðŸ·ï¸ Tag image with release version
        run: |
          TAG_NAME=${{ needs.validate-release.outputs.tag_name }}
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}"
          
          echo "ðŸ·ï¸ Tagging ${IMAGE_NAME}:latest as ${TAG_NAME}"
          docker tag ${IMAGE_NAME}:latest ${IMAGE_NAME}:${TAG_NAME}
          
          echo "ðŸ“¤ Pushing ${IMAGE_NAME}:${TAG_NAME}"
          docker push ${IMAGE_NAME}:${TAG_NAME}
          
          echo "âœ… Release image tagged and pushed: ${TAG_NAME}"

  deploy-production:
    name: ðŸš€ Deploy to EC2 Production
    runs-on: ubuntu-latest
    needs: [pull-artifact]
    environment:
      name: production
      url: https://api.docuflow.id.vn
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸ“¤ Sync docker-compose to EC2
        run: |
          echo "ðŸ“¤ Uploading docker-compose.prod.yml to EC2..."
          scp -i ~/.ssh/deploy_key docker-compose.prod.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/secure-document-management/
          echo "âœ… docker-compose.prod.yml synced"
      
      - name: ðŸ“¦ Deploy to EC2
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}"
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e
            
            echo 'ðŸ”‘ Login to Docker Hub...'
            echo '${{ secrets.DOCKER_PASSWORD }}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin
            
            echo 'ðŸ“¥ Pulling production image...'
            docker pull ${IMAGE_NAME}:${TAG_NAME}
            
            cd /home/${{ secrets.EC2_USER }}/secure-document-management
            
            echo 'ðŸ“ Updating docker-compose with new version...'
            export IMAGE_TAG=${TAG_NAME}
            export IMAGE_NAME=${IMAGE_NAME}
            
            echo 'ðŸ›‘ Stopping current containers...'
            docker-compose -f docker-compose.prod.yml --env-file .env.prod down app || true
            
            echo 'ðŸš€ Starting new version...'
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d app
            
            echo 'â³ Waiting for container to be ready...'
            sleep 30
            
            echo 'ðŸ“Š Container status:'
            docker-compose -f docker-compose.prod.yml ps app
            
            echo 'ðŸ§¹ Cleaning up old images...'
            docker image prune -f
            
            echo 'âœ… Deployment completed for version ${TAG_NAME}'
          "
      
      - name: ðŸ¥ Health Check
        run: |
          echo "â³ Waiting for application to start..."
          sleep 15
          
          HEALTH_URL="https://api.docuflow.id.vn/api/health"
          
          for i in {1..10}; do
            echo "ðŸ” Health check attempt $i/10..."
            
            STATUS_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            
            if [ "$STATUS_CODE" = "200" ]; then
              echo "âœ… Health check passed! Application is healthy."
              
              # Get response details
              RESPONSE=$(curl -k -s "$HEALTH_URL")
              echo "ðŸ“Š Health check response: $RESPONSE"
              
              exit 0
            fi
            
            echo "â³ Attempt $i failed (HTTP $STATUS_CODE), waiting 10 seconds..."
            sleep 10
          done
          
          echo "âŒ Health check failed after 10 attempts"
          echo "ðŸ” Checking application logs..."
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            cd /home/${{ secrets.EC2_USER }}/secure-document-management
            docker-compose -f docker-compose.prod.yml logs --tail=50 app
          "
          
          exit 1
      
      - name: ðŸ“Š Deployment Info
        if: success()
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${TAG_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://api.docuflow.id.vn" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Production deployment completed successfully!"

  rollback-on-failure:
    name: ðŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: failure()
    steps:
      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸ”„ Rollback to previous version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            cd /home/${{ secrets.EC2_USER }}/secure-document-management
            
            echo 'âš ï¸ Deployment failed, initiating rollback...'
            
            # Get previous image tag from docker
            PREVIOUS_TAG=\$(docker images ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }} --format '{{.Tag}}' | grep '^v' | grep -v '${TAG_NAME}' | head -1)
            
            if [ -z \"\$PREVIOUS_TAG\" ]; then
              echo 'âŒ No previous version found for rollback'
              exit 1
            fi
            
            echo \"ðŸ”„ Rolling back to version: \$PREVIOUS_TAG\"
            
            export IMAGE_TAG=\$PREVIOUS_TAG
            export IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}
            
            docker-compose -f docker-compose.prod.yml --env-file .env.prod down app
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d app
            
            echo \"âœ… Rollback to \$PREVIOUS_TAG completed\"
          "
      
      - name: ðŸ“¢ Rollback notification
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# âš ï¸ Deployment Failed - Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Version:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ðŸ”„ Rolled back to previous version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check logs and fix issues before redeploying." >> $GITHUB_STEP_SUMMARY

  notify:
    name: ðŸ“¢ Deployment Status
    runs-on: ubuntu-latest
    needs: [validate-release, deploy-production]
    if: always()
    steps:
      - name: âœ… Success notification
        if: needs.deploy-production.result == 'success'
        run: |
          TAG_NAME=${{ needs.validate-release.outputs.tag_name }}
          
          echo "# âœ… Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Version | ${TAG_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Image | \`${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${TAG_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ URL | https://api.docuflow.id.vn |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Deployed at | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Status | ðŸŸ¢ Live |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Application is now running in production!**" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Failure notification
        if: needs.deploy-production.result == 'failure'
        run: |
          TAG_NAME=${{ needs.validate-release.outputs.tag_name }}
          
          echo "# âŒ Production Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Version | ${TAG_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Status | ðŸ”´ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Failed at | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Rollback has been initiated. Check logs for details.**" >> $GITHUB_STEP_SUMMARY
          
          exit 1
