name: ðŸš€ Production Deployment

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger khi Ä‘Ã¡nh tag: v1.0.0, v2.1.3, etc.

env:
  NODE_VERSION: '18'
  APP_NAME: secure-document-management

jobs:
  pre-deploy-checks:
    name: ðŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“Œ Validate tag format
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "âœ… Expected format: v1.0.0"
            exit 1
          fi
          echo "âœ… Tag format valid: $TAG_NAME"
      
      - name: ðŸ“‹ Extract release notes
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# ðŸš€ Production Release: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Released at:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: ðŸ”’ Security Scanning
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      
      - run: npm ci
      
      - name: ðŸ” Secrets Scan
        uses: GitGuardian/ggshield-action@v1.25.0
        continue-on-error: true
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
      
      - name: ðŸ”’ Dependency Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: [security-scan]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate
      
      - name: ðŸ“Š Run linting
        run: npm run lint
        continue-on-error: true
      
      - name: ðŸ—ï¸ Build application
        run: npm run build
      
      - name: âœ… Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist/ directory not found"
            exit 1
          fi
          echo "âœ… Build successful"
          ls -la dist/
      
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            package.json
            package-lock.json
            prisma/
          retention-days: 7

  container-scan:
    name: ðŸ³ Container Security
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Build Docker image
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          docker build -t ${{ env.APP_NAME }}:${TAG_NAME} .
          docker tag ${{ env.APP_NAME }}:${TAG_NAME} ${{ env.APP_NAME }}:latest
      
      - name: ðŸ” Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.APP_NAME }}:latest
          severity: CRITICAL,HIGH
          exit-code: 0

  deploy-production:
    name: ðŸš€ Deploy to EC2 Production
    runs-on: ubuntu-latest
    needs: [container-scan]
    environment:
      name: production
      url: https://api.yourdomain.com
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
      
      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸ“¦ Deploy to EC2
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # Create deployment directory
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            mkdir -p /var/www/${{ env.APP_NAME }}/releases/${TAG_NAME}
          "
          
          # Upload files
          scp -i ~/.ssh/deploy_key -r \
            dist/ package.json package-lock.json prisma/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/${{ env.APP_NAME }}/releases/${TAG_NAME}/
          
          # Deploy and restart
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            cd /var/www/${{ env.APP_NAME }}/releases/${TAG_NAME}
            
            # Install production dependencies
            npm ci --production
            
            # Generate Prisma client
            npx prisma generate
            
            # Run database migrations
            npx prisma migrate deploy
            
            # Update symlink to current release
            ln -sfn /var/www/${{ env.APP_NAME }}/releases/${TAG_NAME} /var/www/${{ env.APP_NAME }}/current
            
            # Restart application (adjust based on your process manager)
            pm2 restart ${{ env.APP_NAME }} || pm2 start /var/www/${{ env.APP_NAME }}/current/dist/main.js --name ${{ env.APP_NAME }}
            
            # Keep only last 5 releases
            cd /var/www/${{ env.APP_NAME }}/releases
            ls -t | tail -n +6 | xargs rm -rf
          "
      
      - name: ðŸ¥ Health check
        run: |
          echo "â³ Waiting for application to start..."
          sleep 10
          
          for i in {1..5}; do
            if curl -f -s ${{ secrets.EC2_HEALTH_CHECK_URL || 'http://${{ secrets.EC2_HOST }}:3000/health' }}; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "â³ Attempt $i/5 failed, retrying..."
            sleep 5
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1

  notify:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    steps:
      - name: âœ… Success notification
        if: needs.deploy-production.result == 'success'
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# âœ… Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ðŸŸ¢ Live" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Application is now running in production!" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Failure notification
        if: needs.deploy-production.result == 'failure'
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "# âŒ Production Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ðŸ”´ Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Please check the deployment logs and retry." >> $GITHUB_STEP_SUMMARY
          exit 1
