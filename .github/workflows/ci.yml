name: ðŸ“¦ CI Pipeline - Build, Test & Security

on:
  pull_request:
    branches: [main]

  # push:
  #   branches: [main]

env:
  NODE_VERSION: '18'
  APP_NAME: secure-document-management
  REGISTRY: docker.io

jobs:
  code-quality:
    name: ðŸ“Š Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      
      - run: npm ci
      
      - name: ðŸ” Run ESLint
        run: npm run lint
        continue-on-error: true

  snyk-scan:
    name: ðŸ”’ Snyk - Dependency Scan
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      
      - run: npm ci
      
      - name: ðŸ”’ Run Snyk scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  gitguardian-scan:
    name: ðŸ” GitGuardian - Secrets Scan
    runs-on: ubuntu-latest
    needs: [snyk-scan]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ” Scan for secrets
        uses: GitGuardian/ggshield-action@v1.25.0
        continue-on-error: true
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  sonarqube-scan:
    name: ðŸ” SonarQube - Code Quality & Coverage
    runs-on: ubuntu-latest
    needs: [gitguardian-scan]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      
      - run: npm ci
      
      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate
        continue-on-error: true
      
      - name: ðŸ“Š Generate coverage
        run: npm run test:cov || true
        continue-on-error: true
      
      - name: ðŸ” Run SonarCloud scan
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build-docker:
    name: ðŸ³ Build Docker Image (Staging)
    runs-on: ubuntu-latest
    needs: [sonarqube-scan]
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Build Docker image
        run: |
          docker build -t ${{ env.APP_NAME }}:staging .
          docker tag ${{ env.APP_NAME }}:staging ${{ env.APP_NAME }}:scan
      
      - name: ðŸ’¾ Save Docker image
        run: |
          mkdir -p /tmp/docker
          docker save ${{ env.APP_NAME }}:staging -o /tmp/docker/image.tar
      
      - name: ðŸ“¤ Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-staging
          path: /tmp/docker/image.tar
          retention-days: 7

  trivy-scan:
    name: ðŸ³ Trivy - Container Scan
    runs-on: ubuntu-latest
    needs: [build-docker]
    steps:
      - name: ðŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-staging
          path: /tmp/docker
      
      - name: ðŸ”„ Load Docker image
        run: docker load -i /tmp/docker/image.tar
      
      - name: ðŸ” Scan with Trivy
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.APP_NAME }}:staging
          severity: CRITICAL,HIGH
          exit-code: 0

  owasp-zap-scan:
    name: ðŸŽ¯ OWASP ZAP - API Security Test
    runs-on: ubuntu-latest
    needs: [trivy-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ”‘ Get JWT Token for Authentication
        id: get-token
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Get JWT token
          RESPONSE=$(curl -s -k -X POST "https://api.docuflow.id.vn/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"hocvu2003@gmail.com","password":"hocvu"}')
          
          echo "Response: $RESPONSE"
          
          # Extract token (check nested data object first)
          TOKEN=$(echo "$RESPONSE" | jq -r '.data.accessToken // .accessToken // .access_token // .data.token // .token // empty')
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âš ï¸ Warning: Could not get JWT token. Scan will run without authentication."
            echo "Response structure: $(echo "$RESPONSE" | jq -c 'keys')"
            echo "authenticated=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Successfully obtained JWT token (first 20 chars): ${TOKEN:0:20}..."
            echo "token=$TOKEN" >> $GITHUB_OUTPUT
            echo "authenticated=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: ðŸŽ¯ Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: https://api.docuflow.id.vn
          rules_file_name: .zap/rules.tsv
          cmd_options: -a -j
        env:
          ZAP_AUTH_HEADER_VALUE: ${{ steps.get-token.outputs.authenticated == 'true' && format('Bearer {0}', steps.get-token.outputs.token) || '' }}

  publish-artifact:
    name: ðŸ“¦ Publish Artifacts
    runs-on: ubuntu-latest
    needs: [trivy-scan, owasp-zap-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-staging
          path: /tmp/docker
      
      - name: ðŸ”„ Load Docker image
        run: docker load -i /tmp/docker/image.tar
      
      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: ðŸ·ï¸ Tag and push image
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}"
          
          docker tag ${{ env.APP_NAME }}:staging ${IMAGE_NAME}:${COMMIT_SHA}
          docker tag ${{ env.APP_NAME }}:staging ${IMAGE_NAME}:latest
          
          echo "ðŸ“¤ Pushing ${IMAGE_NAME}:${COMMIT_SHA}"
          docker push ${IMAGE_NAME}:${COMMIT_SHA}
          
          echo "ðŸ“¤ Pushing ${IMAGE_NAME}:latest"
          docker push ${IMAGE_NAME}:latest
          
          echo "âœ… Published: ${IMAGE_NAME}:${COMMIT_SHA}"
          echo "âœ… Published: ${IMAGE_NAME}:latest"

  ci-summary:
    name: ðŸ“‹ CI Pipeline Summary
    runs-on: ubuntu-latest
    needs: [snyk-scan, gitguardian-scan, sonarqube-scan, trivy-scan, owasp-zap-scan, publish-artifact]
    if: always()
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Quality | Code Quality & Linting | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | Snyk Dependency Scan | ${{ needs.snyk-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Security | GitGuardian Secrets Scan | ${{ needs.gitguardian-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Quality | SonarQube Analysis | ${{ needs.sonarqube-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Security | Trivy Container Scan | ${{ needs.trivy-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Security | OWASP ZAP API Test | ${{ needs.owasp-zap-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Publish | Artifact Publishing | ${{ needs.publish-artifact.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "**Docker Image:** \`${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:${COMMIT_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** \`${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
